<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장바구니</title>
    <link rel="stylesheet" href="/css/layout/common.css">
     <link rel="stylesheet" type="text/css" th:href="@{/css/cart.css}">
</head>
<body>
<div th:replace="fragment/header :: headerFragment"></div>
    <div class="cart_area">
    <div class="round_box">
        <h1>장바구니</h1>
        <div class="cart-header">
            <label><input type="checkbox" id="select-all"> 전체 선택</label>
            <span id="delete-selected">선택 삭제</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"> 전체 선택</th>
                    <th>이미지</th>
                    <th>상품명</th>
                    <th>가격</th>
                    <th>수량</th>
                    <th>합계</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody id="cart-items">
	            <tr id="empty-cart-message" style="display: none;">
			        <td colspan="7" style="text-align: center; padding: 20px;">
			            장바구니에 담긴 제품이 없어요.<br><br>
			            <button onclick="location.href='/products'" class="go-store-btn">스토어로 이동 ></button>
			        </td>
			    </tr>
                <tr th:each="item : ${cartItems}" th:data-item-id="${item.id}">
                    <td><input type="checkbox" name="selectedItems" th:value="${item.id}"></td>
                    <td><img th:src="@{${item.imageUrl}}" alt="Product Image" class="product-image" th:data-product-id="${item.productId}"/></td>
                    <td><span th:text="${item.productName}"></span></td>
                    <td><span th:text="${item.price}" th:data-item-id="${item.id}" ></span> 원</td>
                    <td>
                        <button type="button" class="decrease" th:data-item-id="${item.id}">-</button>
                        <input type="number" name="quantity" th:value="${item.quantity}" min="1" th:data-item-id="${item.id}">
                        <button type="button" class="increase" th:data-item-id="${item.id}">+</button>
                    </td>
                    <td><span class="subtotal" th:text="${item.price * item.quantity}"></span> 원</td>
                    <td><button type="button" class="delete-button" th:data-item-id="${item.id}">X</button></td>
                </tr>
            </tbody>
        </table>

        <div class="total-container">
            총 결제금액: <span id="selected-total">0</span> 원
        </div>
        <button type="button">주문하기</button>
    </div>
</div>
<div th:replace="fragment/footer :: footerFragment"></div>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	
    <script>
	    $(document).on('click', '.product-image', function() {
	        const productId = $(this).data('product-id');
	        window.location.href = `/products/${productId}`;
	    });
	       
	    $(document).ready(function() {
	        // 전체 선택 체크박스 클릭 이벤트
	        $('#select-all').on('change', function() {
	            const isChecked = $(this).prop('checked');
	            $('input[name="selectedItems"]').prop('checked', isChecked);
	            updateSelectedTotal(); // 총합 업데이트
	        });

	        // 개별 체크박스 클릭 시 전체 선택 상태 업데이트
	        $(document).on('change', 'input[name="selectedItems"]', function() {
	            const totalCheckboxes = $('input[name="selectedItems"]').length;
	            const checkedCheckboxes = $('input[name="selectedItems"]:checked').length;
	            $('#select-all').prop('checked', totalCheckboxes === checkedCheckboxes);
	            updateSelectedTotal();
	        });
	    });
	
	    // 선택된 아이템들의 총합 계산
	    function updateSelectedTotal() {
	        let total = 0;
	        $('input[name="selectedItems"]:checked').each(function() {
	            const itemId = $(this).val();
	            const quantity = parseInt($(`input[data-item-id="${itemId}"]`).val());
	            const price = parseFloat($(`td span[data-item-id="${itemId}"]`).text());  
	            console.log(`itemId: ${itemId}, quantity: ${quantity}, price: ${price}`);
	            total += price * quantity;
	        });
	       
	        $('#selected-total').text(total.toLocaleString());
	    }
    
        // 수량 증가/감소 처리
        $(document).on('click', '.increase, .decrease', function() {
            const itemId = $(this).data('item-id');
            const quantityInput = $(`input[data-item-id="${itemId}"]`);
            let quantity = parseInt(quantityInput.val());

            if ($(this).hasClass('increase')) quantity++;
            else if ($(this).hasClass('decrease') && quantity > 1) quantity--;

            quantityInput.val(quantity);
            updateQuantity(itemId, quantity);
        });

        // 수량 업데이트 요청
        function updateQuantity(itemId, quantity) {
            $.ajax({
                url: `/cart/items/${itemId}/update`,
                method: 'PUT',
                data: { quantity: quantity },
                success: function(response) {
                	console.log('AJAX 요청 성공');
                    updateCartUI(response);
                    updateSelectedTotal();
                    updateCartCount(response.cartItems.length);
                    alert('수량이 변경되었습니다!');
                },
                error: function() {
                    alert('수량 업데이트 실패');
                }
            });
        }
     

     // 삭제 버튼 클릭
        $(document).on('click', '.delete-button', function() {
            const itemId = $(this).data('item-id');
            deleteCartItem(itemId); // 단일 아이템 삭제
        });

        // 선택 삭제
        $('#delete-selected').on('click', function() {
            const selectedItems = $('input[name="selectedItems"]:checked').map(function() {
                return $(this).val();
            }).get();

            if (selectedItems.length > 0) {
                deleteSelectedItems(selectedItems); // 선택된 상품 삭제
            } else {
                alert('삭제할 상품을 선택해주세요.');
            }
        });

        // 단일 아이템 삭제 함수
        function deleteCartItem(itemId) {
            $.ajax({
                url: `/cart/items/${itemId}/remove`,
                method: 'DELETE',
                success: function(response) {
                    console.log(response);
                    updateCartCount(response.cartItems.length);
                    alert('상품이 삭제되었습니다!');
                    removeItemFromUI(itemId); // UI에서 상품 삭제
                    updateCartUI(response); // 장바구니 UI 업데이트
                    updateSelectedTotal(); // 총합 업데이트

                },
                error: function() {
                    alert('삭제 실패');
                }
            });
        }

        // 선택된 상품 삭제 함수
        function deleteSelectedItems(selectedItems) {
            $.ajax({
                url: '/cart/items/remove',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify(selectedItems),
                success: function(response) {
                    console.log(response);
                    alert('선택한 상품들이 삭제되었습니다!');
                    updateCartCount(response.cartItems.length);
                    removeItemsFromUI(selectedItems); // 선택된 상품 UI에서 삭제
                    updateCartUI(response); // 장바구니 UI 업데이트
                    updateSelectedTotal(); // 총합 업데이트

                },
                error: function() {
                    alert('삭제 실패');
                }
            });
        }
          function updateCartCount(count) {
              $('.cart-badge').text(count);
          }

        // UI에서 단일 아이템 삭제 함수
        function removeItemFromUI(itemId) {
            $(`tr[data-item-id="${itemId}"]`).remove(); // 해당 아이템 UI에서 삭제
        }

        // UI에서 선택된 상품들 삭제 함수
        function removeItemsFromUI(itemIds) {
            itemIds.forEach(itemId => {
                $(`tr[data-item-id="${itemId}"]`).remove(); // 선택된 아이템들 UI에서 삭제
            });
        }

        function checkEmptyCart() {
            const cartItems = document.querySelectorAll("#cart-items tr:not(#empty-cart-message)");
            const emptyMessage = document.getElementById("empty-cart-message");

            if (cartItems.length === 0) {
                emptyMessage.style.display = "table-row"; // 메시지 보이게
            } else {
                emptyMessage.style.display = "none"; // 메시지 숨기기
            }
        }

        // 초기 체크
        checkEmptyCart();

        // 상품 삭제 후 장바구니 비었는지 확인하는 부분 추가
        function removeItemFromUI(itemId) {
            $(`tr[data-item-id="${itemId}"]`).remove();
            checkEmptyCart(); // 삭제 후 체크
        }

        function removeItemsFromUI(itemIds) {
            itemIds.forEach(itemId => {
                $(`tr[data-item-id="${itemId}"]`).remove();
            });
            checkEmptyCart(); // 삭제 후 체크
        }
        
       
        // 장바구니 UI 업데이트
        function updateCartUI(cartDTO) {
        	 let totalPrice = 0;

        	    cartDTO.cartItems.forEach(item => {
        	        const itemRow = $(`tr[data-item-id="${item.id}"]`);
        	        if (itemRow.length > 0) {
        	            itemRow.find('input[name="quantity"]').val(item.quantity);  // 수량 업데이트
        	            itemRow.find('.subtotal').text((item.price * item.quantity).toLocaleString()); // 개별 합계 업데이트
        	        }
        	        totalPrice += item.price * item.quantity;
        	    });

        	    $('#selected-total').text(totalPrice.toLocaleString() + ' 원');
        }
         

    </script>
</body>
</html>
