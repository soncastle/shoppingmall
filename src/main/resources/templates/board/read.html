<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>게시글 상세</title>
<link rel="stylesheet" href="/css/layout/common.css">
<link rel="stylesheet" href="/css/board/read.css">
</head>
<body>

	<div th:replace="fragment/header :: headerFragment"></div>
	<div th:replace="fragment/nav :: navFragment"></div>

	<div class="container">
		<div class="pm-section">
			<div th:if="${board == null}" class="noPage">
				<p>게시글을 찾을 수 없습니다.</p>
			</div>
			<div th:if="${board != null}">
				<div>
					<span th:text="${board.categoryId}" class="boardCategoryId"></span>
					<h2 th:text="${board.title}" class="boardTitle"></h2>
					<div class="userInfo">
						<img th:src="${board.user.userImg.url}" class="userImage">
						<div class="userInfoText">
							<span th:text="${board.nickname}" class="boardNickname"></span>
							<span class="boardViewCount">조회수 [[${board.viewCount}]]</span>
						</div>
					</div>
					<div class="createdAt">
						<span th:text="${#temporals.format(board.createdAt, 'yyyy-MM-dd HH:mm:ss')}" class="boardCreatedAt"></span>
						<span><a>공유</a></span>
					</div>
					<hr>
				</div>

				<div class="contentContain">
					<div th:utext="${board.content}" class="boardContent"></div>
				</div><br><br>

				<span th:each="hashtag : ${board.hashtag}"> 
					<a th:href="@{/board/board(hashtag=${hashtag})}" class="boardHashtag" th:text="${hashtag}"></a>
				</span><br><br><br>

				<div class="buttons">
					<a th:href="@{/board/update(boardId=${board.boardId})}" class="update">수정</a>
					<a th:href="@{/board/delete(boardId=${board.boardId})}" class="deleteBtn" th:data-board-id="${board.boardId}">삭제</a>
				</div><br><br>

				<div class="likeContain">
					<a href="#" th:if="${#lists.contains(board.likeContain, user.id)}" id="likeCount"
						class="likeButton" th:data-board-id="${board.boardId}" th:data-id="${user.id}">❤️ [[${board.likeCount}]]</a> 
					<a href="#" th:unless="${#lists.contains(board.likeContain, user.id)}" id="likeCount" 
						class="likeButton" th:data-board-id="${board.boardId}" th:data-id="${user.id}">🤍 [[${board.likeCount}]]</a>
					<a href="#" id="commentButton" class="commentButton">🗨️</a>
						<span th:text="${board.commentCount}" class="boardCommentCount"></span>
				</div>
				
				<hr>
				
				<h3 class="comments">댓글</h3>
				
				<div class="commentWrite">
					<img th:src="${user.userImg.url}" class="commentWriteUserImage">
					<form action="/board/commentCreate">
						<input type="hidden" name="boardId" th:value="${board.boardId}">
						<textarea id="content" name="content" rows="4" class="commentWriteContent" placeholder="댓글을 입력해주세요" required></textarea>
						<button type="submit" class="commentWriteButton">댓글 작성</button>
					</form>
				</div>

				<div class="commentList" th:each="comment : ${comment}">
					<img th:src="${comment.user.userImg.url}" class="commentUserImage">
					<div class="comment">
						<div class="commentNicknameCreatedAt">
							<p class="commentNickname" th:text="${comment.nickname}"></p>
							<p class="commentCreatedAt" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></p>
						</div>
						<p class="commentContent" th:text="${comment.content}"></p>
						<div class="commentButtons">
							<a th:href="@{/board/commentUpdate(commentId=${comment.commentId})}" class="commentUpdate">수정</a> 
							<a th:href="@{/board/commentDelete(commentId=${comment.commentId}, boardId=${board.boardId})}" class="commentDelete">삭제</a> 
							<a href="#" th:if="${#lists.contains(comment.likeContain, user.id)}" class="commentLikeCount" 
								th:data-comment-id="${comment.commentId}" th:data-id="${user.id}">❤️ [[${comment.likeCount}]]</a>
							<a href="#" th:unless="${#lists.contains(comment.likeContain, user.id)}" class="commentLikeCount" 
								th:data-comment-id="${comment.commentId}" th:data-id="${user.id}">🤍 [[${comment.likeCount}]]</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div th:replace="fragment/footer :: footerFragment"></div>

</body>
<script>
const commentBtn = document.getElementById("commentButton")
commentBtn.addEventListener("click", (e)=>{
	e.preventDefault();
	document.querySelector(".likeContain").scrollIntoView({
        behavior: "smooth",
        block: "start"
    });
})

document.addEventListener("DOMContentLoaded", (e) =>{
    const likesBtn = document.getElementById("likeCount");
    const boardId = likesBtn.dataset.boardId;
    const userId = likesBtn.dataset.id;
    likesBtn.addEventListener("click" , async (e) =>{
      e.preventDefault();

      const data = {
        boardId : boardId,
        userId : userId
      }

      const response = await fetch(`/board/like` , {

        method : "POST" ,
        headers : {
          "Content-Type" : "application/json"
        },
        body : JSON.stringify(data)

      })

      const result = await response.json()

      if(!response.ok){
        console.log("데이터를 못받아왔씁니다")
      }
      
      if(result.data.contain === "contained"){
    	  likesBtn.textContent = `❤️ ${result.data.likeCount}`;
      }
      else {
    	  likesBtn.textContent = `🤍 ${result.data.likeCount}`;
      }


    })


    const deleteBtn = document.querySelector(".deleteBtn")
    console.log(deleteBtn)
    deleteBtn.addEventListener("click", async (e) =>{
      e.preventDefault();
      const boardId = deleteBtn.getAttribute("data-board-id");

      const conn = confirm("정말 삭제하시겠습니까?")
      if (conn){
        const response = await fetch(`/board/delete?boardId=${Number(boardId)}` , {
          method : "DELETE",
          credentials : "include"
        })

        if(!response.ok){
          console.log("삭제 실패했습니다.")
        }

        if(response.ok){
          alert("게시물 삭제 완료")
          window.location.href = "/board/main"
        }
      }
    })
  })
document.addEventListener("DOMContentLoaded", (e) =>{
	const likeButtons = document.querySelectorAll(".commentLikeCount");
	
	likeButtons.forEach(likesBtn => {
		const commentId = likesBtn.dataset.commentId;
		const userId = likesBtn.dataset.id;
		
		likesBtn.addEventListener("click" , async (e) =>{
			e.preventDefault();
		
		const data = {
		  commentId : commentId,
		  userId : userId
		}
		const response = await fetch(`/board/commentLike` , {
			
	        method : "POST" ,
	        headers : {
	          "Content-Type" : "application/json"
	        },
	        body : JSON.stringify(data)
	
	      })
	
	      const result = await response.json()
	
	      if(!response.ok){
	        console.log("데이터를 못받아왔씁니다")
	      }
	      
	      if(result.data.contain === "contained"){
	    	  likesBtn.textContent = `❤️ ${result.data.commentLikeCount}`;
	      }
	      else {
	    	  likesBtn.textContent = `🤍 ${result.data.commentLikeCount}`;
	      }
    	})
	})  
  })
</script>
</html>